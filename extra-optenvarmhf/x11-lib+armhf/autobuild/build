export PKG_CONFIG_LIBDIR=/opt/armhf/lib/pkgconfig
export PATH=/opt/abcross/optenvarmhf/bin:$PATH

unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS

XORG_CONFIG="--prefix=/opt/armhf --disable-static --enable-shared --build=${ARCH_TARGET[$ARCH]} --host=arm-aosc-linux-gnueabihf xorg_cv_malloc0_returns_null=yes"

for package in $(grep -v '^#' lib-7.7.md5 | awk '{print $2}')
do
    packagedir=${package%.tar.bz2}
    pushd $packagedir
    case $packagedir in
        libXfont-[0-9]* )
            ./configure $XORG_CONFIG --disable-devel-docs \
                        || exit 1
            ;;
        libXt-[0-9]* )
            ./configure $XORG_CONFIG \
                        --with-appdefaultdir=/etc/X11/app-defaults \
                        || exit 1
            ;;
        * )
            ./configure $XORG_CONFIG \
                        || exit 1
            ;;
    esac
    make || exit 1
    make install
    [ -d /opt/armhf/share/pkgconfig ] && ( mv -v /opt/armhf/share/pkgconfig/* /opt/armhf/lib/pkgconfig/ && rm -rf /opt/armhf/share/pkgconfig ) || true
    make DESTDIR="$PKGDIR" install || exit 1
    popd
done

rm -rf "$PKGDIR"/etc
mkdir -pv "$PKGDIR"/opt/armhf/lib/pkgconfig
mv -v "$PKGDIR"/opt/armhf/share/pkgconfig/* "$PKGDIR"/opt/armhf/lib/pkgconfig/
rm -rf "$PKGDIR"/opt/armhf/{bin,share}
mkdir -pv "$PKGDIR"/opt/armhf/share
ln -sfv /usr/share/X11 "$PKGDIR"/opt/armhf/share/
